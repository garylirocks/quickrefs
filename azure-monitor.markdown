# Azure Monitor

- [Overview](#overview)
- [Azure Monitor](#azure-monitor-1)
  - [VMs](#vms)
- [Defender for Cloud](#defender-for-cloud)
- [Alerting](#alerting)
- [Activity Log](#activity-log)
- [Log Analytics](#log-analytics)
  - [Design considerations](#design-considerations)
  - [Access Control](#access-control)
    - [Access modes](#access-modes)
- [Kusto Query Language](#kusto-query-language)
- [Workbooks](#workbooks)
- [Insights](#insights)
  - [Azure Application Insights](#azure-application-insights)
  - [VM Insights](#vm-insights)
- [Azure Data Explorer](#azure-data-explorer)

## Overview

![monitoring services](images/azure_monitoring-services.png)

Monitoring services in logical groups:

- Core monitoring

  Platform level, built-in to Azure, requires little to no configuration to set up.

  - Activity Log
  - Service Health
    - Identifies any issues with Azure services that might affect your application
    - Helps you plan for scheduled maintenance
  - Azure Monitor (metrics and diagnostics)
  - Advisor
    - Potential performance, cost, high availability or security issues

- Log Analytics

- Application Insights: APM
  - Identify performance issues, usage trends, and the overall availability of services

## Azure Monitor

![Azure Monitor Overview](images/azure_monitor.png)

Azure Monitor is based on a common mornitoring data platform that includes Logs and Metrics.

| Logs                           | Metrics                          |
| ------------------------------ | -------------------------------- |
| text (can have numeric fields) | numeric values                   |
| sporadic                       | at fixed interval                |
| record event                   | describe some aspect of a system |
| identify root causes           | performance, alerting            |
| Log Analytics workspace        | time-series database             |

- What can be collected:
  - **Metrics**: usually displayed in the overview page of resources
  - **Platform logs**
    - Resource logs (formerly known as diagnostic logs)
    - Activity logs
    - Azure AD logs
  - **Application logs**
- Usually for a resource:
  - *Metrics* and the *Activity logs* are collected and stored automatically, but can be routed to other locations by using a *diagnostic setting*.
  - *Resource Logs* are not collected and stored until you create a *diagnostic setting* and route them to one or more locations.
- Use *Data Collector API* to send data from your custom code

### VMs

![data sources in a VM](images/azure_monitor-compute.png)

For VMs, Azure collects some metrics(host-level) by default, such as CPU usage, OS disk usage, network traffic, boot success, to get a full set of metrics, you need to install certain agents:

- **Azure Monitor Agent**: going to replace Log Analytics Agent and Azure Diagnostics extension over time
- **Log Analytics Agent**:
  - works in Azure, other clouds, or on-prem
  - allows for the onboarding of *Azure Monitor VM Insights*, *Microsoft Defender for Cloud*, and *Microsoft Sentinel*
  - works with Azure Automation accounts to onboard Azure Update Management and Azure Automation State Configuration, Change Tracking and Inventory
- **Azure Diagnostics extension**: mainly metrics (not the same as boot diagnostics, which you usually enable while creating a VM)
- **Dependency agent**: maps dependencies between VMs


## Defender for Cloud

- Formerly called Azure Security Center
- Free features are automatically enabled for your subscriptions when you visit "Defender for Cloud" in the Portal
- You could turn on "Enhanced security features" (Defender plan by resource type)
- Some plans could be enabled at either subscription level or resource level
  - Defender for Storage account
  - Defender for SQL
- Collects data from resources such as VMs by using the Log Analytics Agent, and puts it into a workspace;
  - Log Analytics Agent can be provisioned automatically


## Alerting

- Metric alerts
- Log alerts
- Activity Log alerts (resource creation, deletion, etc)


## Activity Log

![Activity Log types](images/azure_activity-logs.png)

- Tracks any write operations taken on your resources, eg. VM startup, load balancer config change, etc
- Log data is retained for 90 days, although you can archive your data to a storage account, or send it to Log Analytics
- Event Categories:
  - Administrative, eg. create a VM
  - Searvice Health
  - Resource Health
  - Alert
  - Autoscale
  - Recommendation
  - Security, alerts generated by Azure Defender for Servers
  - Policy, all effect action operations performed by Azure Policy


## Log Analytics

![Log Analytics](images/azure_log-analytics.png)

- Azure Monitor stores log data in a Log Analytics workspace
- A Log Analytics workspace is the **equivalent of a database** inside Azure Data Explorer, data is organized into tables
- Data collected can be retained for a maximum of two years
- These services all use Log Analytics workspaces to store and query logs:
  - Microsoft Defender for Cloud
  - Microsoft Sentinel
  - Azure Monitor Application Insights

### Design considerations

Common workspace deployment models:

- **Centralized** (*hub and spoke*)
  - All logs in one workspace
  - You need to maintain access control to different users
  - Easier to cross-correlate logs
  - Example: ![Centralized design](images/azure_log-analytics-workspace-centralized-design.png)
- **Decentralized**
  - Each team has their own workspace in their own resource group
  - Access control is consistent with resource access
  - Difficult to cross-correlate logs
- **Hybrid** not recommended, hard to maintain

You many need multiple workspaces because:

- Store log data in specific regions for data sovereignty or compliance
- Put workspace in the same region as resources to avoid outbound data transfer charges
- Multiple departments or business groups

Scale and ingestion volume:

- Workspace are **NOT limited** in storage space, so no need to split workspaces due to scale.
- There is a default ingestion rate limit (6GB/minute) to protect from spikes and floods situations.
- If you need to ingest more than 4TB data per day, consider moving to *dedicated clusters*

### Access Control

The data a user has access to is determined by a combination of factors that are listed in the following table.

| Factor                 | Description                                                                                                                                                                                    |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Access mode            | How you access a workspace. Defines the scope of the data available and the access control mode that's applied.                                                                                |
| Access control mode    | Setting on the workspace that defines whether permissions are applied at the workspace or resource level. Two modes: 1. Use resource or workspace permissions 2. Require workspace permissions |
| Permissions            | Permissions applied to individual or groups of users for the workspace or resource. Defines what data the user will have access to.                                                            |
| Table level Azure RBAC | *Optional* granular permissions that apply to *all users* regardless of their access mode or access control mode. Defines which data types a user can access.                                  |

#### Access modes

| Issue                | Workspace-context                                                                                                                                                   | Resource-context                                                                                                                                                              |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| How                  | When a workspace is the scope, eg. select **"Logs" in the "Monitor" page** in the Portal                                                                            | When you access the workspace for a paticular resource, resource group, or subscription, eg. select **"Logs" in a resource page** in the Portal                               |
| Intended for         | Central administration (Also currently required for users who need to access logs for resources outside of Azure)                                                   | Application teams. Administrators of Azure resources being monitored.                                                                                                         |
| Permissions required | [Permissions to the workspace](https://docs.microsoft.com/en-us/azure/azure-monitor/logs/manage-access)                                                             | **Read access** to the resource. Permission to the logs for the resource will be automatically assigned.                                                                      |
| Permissions scopes   | Workspace. Users with access to the workspace can query all logs in the workspace from tables that they have permissions to (allowed by optional table-level RBAC). | Azure resource. User can query logs for specific resources, resource groups, or subscription they have access to from any workspace but can't query logs for other resources. |


## Kusto Query Language

KQL was originally written for Azure Data Explorer. See a basic tutorial here: https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/tutorial

Common table names:

![Common table names](images/azure_common-log-tables.png)


Example:

```
Events
| where StartTime >= datetime(2018-11-01) and StartTime < datetime(2018-12-01)
| where State == "FLORIDA"
| count
```

```
Heartbeat
| summarize arg_max(TimeGenerated, *) by ComputerIP
```

```
// Render a chart of average CPU usage in 5-minute interval for each computer

InsightsMetrics
| where TimeGenerated > ago(1h)
| where Origin == "vm.azm.ms"
| where Namespace == "Processor"
| where Name == "UtilizationPercentage"
| summarize avg(Val) by bin(TimeGenerated, 5m), Computer //split up by computer
| render timechart
```

![Query result chart example](images/azure_log-analytics-chart-example.png)


## Workbooks

Allows you to connect to multiple data sources across Azure and combine them into unified interactive reports.


## Insights

- Provide a customized monitoring experience for particular applications and services.
- They collect and analyze both logs and metrics.

Provided insights:

- Application insights: monitor your live web apps on any platform
- Container insights: ACI, AKS
- Cosmos DB insights
- Networks insights: identify resource dependencies
- Resource Group insights
- Storage insights
- VM insights: health and performance of your VM and VMSS, monitor their processes and dependencies on other resources and external processes
- Key Vault insights
- Cache for Redis insights

### Azure Application Insights

- Is an APM (Application Performance Management) service, mostly captures two kinds of data: *events* and *metrics*
- Instrumentation methods:
  - **Runtime instrumentation**: can be enabled without making any changes to code (Windows IIS web app only, works best with ASP.NET)
  - **Build-time instrumentation**: by installing SDK to code, enables full functionality, supports custom events
  - **Client-side instrumentation**: JavaScript SDK, you can configure App Service to inject it automatically (Windows IIS web app only)


### VM Insights

Provide

- Detailed performance metrics
- A topology view showing dependencies like processes running, ports open, connection details, etc
- VMs, VMSS, VMs connected with Azure Arc, on-prem VMs
- Can monitor VMs **across multiple subscriptions** and resource groups

![VM Insights map](images/azure_vm-insights-map.png)


## Azure Data Explorer

- Unified big data analytics platform
- Greater flexibility for building quick and easy near-real-time analytics dashboards, granular RBAC, time series, pattern recognition and machine learning

Example design:

![Data Explorer](images/azure_data-explorer.png)
