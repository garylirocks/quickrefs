# Azure Monitor

- [Overview](#overview)
- [Azure Monitor](#azure-monitor)
- [Azure Security Center](#azure-security-center)
- [Azure Application Insights](#azure-application-insights)
- [Alerting](#alerting)
- [Activity Log](#activity-log)
- [Log Analytics](#log-analytics)
- [Kusto Query Language](#kusto-query-language)

## Overview

![monitoring services](images/azure_monitoring-services.png)

Monitoring services in logical groups:

- Core monitoring

  Platform level, built-in to Azure, requires little to no configuration to set up.

  - Activity Log
  - Service Health
    - Identifies any issues with Azure services that might affect your application
    - Helps you plan for scheduled maintenance
  - Azure Monitor (metrics and diagnostics)
  - Advisor
    - Potential performance, cost, high availability or security issues

- Log Analytics

- Application Insights: APM
  - Identify performance issues, usage trends, and the overall availability of services

## Azure Monitor

![Azure Monitor Overview](images/azure_monitor.png)

| logs                           | metrics                          |
| ------------------------------ | -------------------------------- |
| text (can have numeric fields) | numeric values                   |
| sporadic                       | at fixed interval                |
| record event                   | describe some aspect of a system |
| identify root causes           | performance, alerting            |
| Log Analytics workspace        | time-series database             |

- Collects resource data and platform logs:
  - metrics: usually displayed in the overview page of resources
  - logs
  - platform logs
    - resource logs (formerly known as diagnostic logs)
    - activity logs
    - Azure AD logs
- Azure Monitor is the service at the top, spans across other native monitoring tools in Azure.
  - Azure Application Insights and Azure Security Center store their collected data in workspace for Azure Monitor, you can then use Azure Monitor Log Analytics to interactively query the data;
- Use Data Collector API to send data from your custom code
- Functions: analysis, alerting, autoscaling, streaming to external systems
- For VMs, Azure collects some metrics(host-level) by default, such as CPU usage, OS disk usage, network traffic, boot success, to get a full set of metrics, you need to install certain agents:
  - **Azure Monitor Agent**: going to replace Log Analytics Agent and Azure Diagnostics extension over time
  - **Log Analytics Agent**:
    - works in Azure, other clouds, or on-prem
    - allows for the onboarding of Azure Monitor VM Insights, Microsoft Defender for Cloud, and Microsoft Sentinel
    - works with Azure Automation accounts to onboard Azure Update Management and Azure Automation State Configuration, Change Tracking and Inventory
  - **Azure Diagnostics extension**: mainly metrics (not the same as boot diagnostics, which you usually enable while creating a VM)
  - **Dependency agent**: maps dependencies between VMs

## Azure Security Center

- Collects data from resources such as VMs by using the Log Analytics Agent, and puts it into a workspace;
  - Log Analytics Agent can be provisioned automatically

## Azure Application Insights

- Is an APM (Application Performance Management) service, mostly captures two kinds of data: *events* and *metrics*
- Instrumentation methods:
  - Runtime instrumentation: can be enabled without making any changes to code (Windows IIS web app only, works best with ASP.NET)
  - Build-time instrumentation: by installing SDK to code, enables full functionality, supports custom events
  - Client-side instrumentation: JavaScript SDK, you can configure App Service to inject it automatically (Windows IIS web app only)


## Alerting

- Metric alerts
- Log alerts
- Activity Log alerts (resource creation, deletion, etc)


## Activity Log

![Activity Log types](images/azure_activity-logs.png)

- Tracks any write operations taken on your resources, eg. VM startup, load balancer config change, etc
- Log data is retained for 90 days, although you can archive your data to a storage account, or send it to Log Analytics
- Event Categories:
  - Administrative, eg. create a VM
  - Searvice Health
  - Resource Health
  - Alert
  - Autoscale
  - Recommendation
  - Security, alerts generated by Azure Defender for Servers
  - Policy, all effect action operations performed by Azure Policy

## Log Analytics

![Log Analytics](images/azure_log-analytics.png)

- More diagnostic information and metrics, eg. pull information from SQL server, free disk space of VMs, network dependencies between your systems and services
- Azure Monitor data can be configured to be sent to a Log Analytics workspace
- VMs can have an agent installed to send data


## Kusto Query Language

Example:

```
Events
| where StartTime >= datetime(2018-11-01) and StartTime < datetime(2018-12-01)
| where State == "FLORIDA"
| count
```

```
Heartbeat
| summarize arg_max(TimeGenerated, *) by ComputerIP
```

Common table names:

![Common table names](images/azure_common-log-tables.png)

